# 🎭 AI角色扮演聊天系统 - 架构设计文档

## 📋 项目概述

AI角色扮演聊天系统是一个基于Web的智能对话平台，用户可以与历史人物、文学角色、科学家等AI角色进行深度对话。系统采用现代化的微服务架构，支持语音交互、实时流式响应和智能缓存优化。

## 🏗️ 系统架构

### 整体架构图

```mermaid
graph TB
    subgraph "用户层"
        U[用户浏览器]
        M[移动端]
    end
    
    subgraph "前端层"
        F[Vue.js 前端应用]
        N[Nginx 反向代理]
    end
    
    subgraph "API网关层"
        G[Gin Web框架]
        A[认证中间件]
        R[限流中间件]
        C[CORS中间件]
    end
    
    subgraph "业务服务层"
        AS[认证服务]
        CS[角色服务]
        MS[消息服务]
        AIS[AI服务]
    end
    
    subgraph "数据存储层"
        DB[(MySQL 8.0)]
        RD[(Redis 7.0)]
    end
    
    subgraph "AI服务层"
        OL[Ollama AI服务]
        QW[qwen2.5:1.5b模型]
    end
    
    U --> F
    M --> F
    F --> N
    N --> G
    G --> A
    A --> R
    R --> C
    C --> AS
    C --> CS
    C --> MS
    C --> AIS
    
    AS --> DB
    CS --> DB
    MS --> DB
    AIS --> OL
    
    AS --> RD
    CS --> RD
    MS --> RD
    AIS --> RD
    
    OL --> QW
```

## 🎯 核心功能模块

### 1. 用户认证模块
- **JWT认证**：基于JWT的无状态认证机制
- **会话管理**：Redis存储用户会话信息
- **安全中间件**：请求认证和权限验证

### 2. 角色管理模块
- **角色库**：预置历史人物、文学角色、科学家等
- **角色搜索**：支持按名称、类别搜索角色
- **角色详情**：包含头像、描述、系统提示词等

### 3. 对话管理模块
- **会话创建**：用户与AI角色创建对话会话
- **消息存储**：用户消息和AI回复的持久化存储
- **对话历史**：完整的对话记录管理

### 4. AI对话模块
- **智能回复**：基于Ollama大语言模型的智能对话
- **流式响应**：实时流式输出AI回复内容
- **缓存优化**：AI响应智能缓存，提升响应速度

### 5. 语音交互模块
- **语音输入**：支持实时语音转文字
- **语音输出**：AI回复可转换为语音播放
- **多语言支持**：支持多种语言的语音识别

## 🔄 数据流图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant B as 后端API
    participant R as Redis缓存
    participant D as MySQL数据库
    participant O as Ollama AI
    
    U->>F: 1. 用户登录
    F->>B: 2. POST /auth/login
    B->>D: 3. 验证用户凭据
    D-->>B: 4. 返回用户信息
    B->>R: 5. 存储JWT token
    B-->>F: 6. 返回token和用户信息
    F-->>U: 7. 登录成功
    
    U->>F: 8. 选择AI角色
    F->>B: 9. GET /characters
    B->>R: 10. 检查缓存
    alt 缓存命中
        R-->>B: 11. 返回缓存数据
    else 缓存未命中
        B->>D: 12. 查询角色数据
        D-->>B: 13. 返回角色列表
        B->>R: 14. 更新缓存
    end
    B-->>F: 15. 返回角色列表
    F-->>U: 16. 显示角色选择
    
    U->>F: 17. 创建对话
    F->>B: 18. POST /conversations
    B->>D: 19. 创建对话记录
    D-->>B: 20. 返回对话ID
    B-->>F: 21. 返回对话信息
    F-->>U: 22. 进入聊天界面
    
    U->>F: 23. 发送消息
    F->>B: 24. POST /conversations/{id}/messages/stream
    B->>D: 25. 保存用户消息
    B->>O: 26. 调用AI服务
    O-->>B: 27. 流式返回AI回复
    B-->>F: 28. SSE流式响应
    F-->>U: 29. 实时显示AI回复
    B->>D: 30. 保存AI消息
```

## 🐳 部署架构图

```mermaid
graph TB
    subgraph "Docker容器编排"
        subgraph "前端容器"
            FE[Vue.js应用<br/>Port: 3000]
            NG[Nginx反向代理]
        end
        
        subgraph "后端容器"
            BE[Go API服务<br/>Port: 8080]
        end
        
        subgraph "数据库容器"
            DB[(MySQL 8.0<br/>Port: 3306)]
            RD[(Redis 7.0<br/>Port: 6379)]
        end
        
        subgraph "AI服务容器"
            OL[Ollama AI服务<br/>Port: 11434]
        end
    end
    
    subgraph "外部访问"
        U[用户浏览器]
        API[API客户端]
    end
    
    U --> FE
    API --> BE
    FE --> NG
    NG --> BE
    BE --> DB
    BE --> RD
    BE --> OL
    
    subgraph "数据持久化"
        MYSQL_DATA[(MySQL数据卷)]
        REDIS_DATA[(Redis数据卷)]
        OLLAMA_DATA[(Ollama模型卷)]
    end
    
    DB --> MYSQL_DATA
    RD --> REDIS_DATA
    OL --> OLLAMA_DATA
```

## 🛠️ 技术栈详解

### 前端技术栈
| 技术 | 版本 | 用途 | 优势 |
|------|------|------|------|
| **Vue.js** | 3.3.4 | 前端框架 | 响应式数据绑定，组件化开发 |
| **Vite** | 4.4.9 | 构建工具 | 快速热重载，现代化构建 |
| **Tailwind CSS** | 3.3.3 | CSS框架 | 原子化CSS，快速样式开发 |
| **Pinia** | 2.1.6 | 状态管理 | Vue 3官方推荐的状态管理 |
| **Vue Router** | 4.2.4 | 路由管理 | 单页面应用路由控制 |
| **Axios** | 1.5.0 | HTTP客户端 | 异步请求处理 |

### 后端技术栈
| 技术 | 版本 | 用途 | 优势 |
|------|------|------|------|
| **Go** | 1.23+ | 编程语言 | 高性能，并发处理能力强 |
| **Gin** | 最新 | Web框架 | 轻量级，高性能HTTP框架 |
| **MySQL** | 8.0 | 关系数据库 | 事务支持，数据一致性 |
| **Redis** | 7.0 | 缓存数据库 | 高性能缓存，会话存储 |
| **JWT** | - | 认证机制 | 无状态认证，安全性高 |
| **Swagger** | - | API文档 | 自动生成API文档 |

### AI技术栈
| 技术 | 版本 | 用途 | 优势 |
|------|------|------|------|
| **Ollama** | 最新 | AI服务 | 本地化部署，数据隐私保护 |
| **qwen2.5:1.5b** | 1.5B参数 | 语言模型 | 轻量级，响应速度快 |

## 📊 数据库设计

### 核心数据表

```mermaid
erDiagram
    USERS {
        int id PK
        varchar username UK
        varchar email UK
        varchar password_hash
        timestamp created_at
        timestamp updated_at
    }
    
    CHARACTERS {
        int id PK
        varchar name UK
        text description
        varchar avatar_url
        text system_prompt
        varchar category
        timestamp created_at
        timestamp updated_at
    }
    
    CONVERSATIONS {
        int id PK
        int user_id FK
        int character_id FK
        varchar title
        timestamp created_at
        timestamp updated_at
    }
    
    MESSAGES {
        int id PK
        int conversation_id FK
        enum role
        text content
        varchar audio_url
        timestamp created_at
    }
    
    USERS ||--o{ CONVERSATIONS : "creates"
    CHARACTERS ||--o{ CONVERSATIONS : "participates"
    CONVERSATIONS ||--o{ MESSAGES : "contains"
```

### 缓存策略

```mermaid
graph LR
    subgraph "缓存层级"
        L1[L1: 内存缓存<br/>角色数据]
        L2[L2: Redis缓存<br/>AI响应]
        L3[L3: 数据库<br/>持久化存储]
    end
    
    subgraph "缓存策略"
        LRU[LRU淘汰策略]
        TTL[TTL过期策略]
        WRITE[写回策略]
    end
    
    L1 --> L2
    L2 --> L3
    L1 --> LRU
    L2 --> TTL
    L3 --> WRITE
```

## 🔒 安全架构

### 认证与授权
- **JWT Token**：无状态认证，支持分布式部署
- **Redis会话**：会话信息缓存，支持集群部署
- **中间件保护**：请求认证、权限验证、限流控制

### 数据安全
- **密码加密**：bcrypt哈希加密存储
- **SQL注入防护**：参数化查询，ORM保护
- **XSS防护**：输入验证，输出转义
- **CSRF防护**：同源策略，Token验证

### API安全
- **限流控制**：防止API滥用，保护系统稳定
- **CORS配置**：跨域请求控制
- **HTTPS支持**：数据传输加密

## ⚡ 性能优化

### 缓存优化
- **多层缓存**：内存缓存 + Redis缓存 + 数据库
- **智能缓存**：AI响应缓存，减少重复计算
- **缓存预热**：角色数据预加载

### 数据库优化
- **索引优化**：关键字段建立索引
- **查询优化**：分页查询，避免全表扫描
- **连接池**：数据库连接复用

### 前端优化
- **代码分割**：按需加载，减少初始包大小
- **静态资源**：CDN加速，图片压缩
- **响应式设计**：移动端适配优化

## 🚀 部署方案

### Docker容器化部署
```bash
# 一键启动所有服务
docker-compose up -d

# 服务列表
- 前端服务: http://localhost:3000
- 后端API: http://localhost:8080
- Swagger文档: http://localhost:8080/swagger
- MySQL: localhost:3306
- Redis: localhost:6379
- Ollama: localhost:11434
```

### 生产环境部署建议
1. **负载均衡**：Nginx反向代理，多实例部署
2. **数据库集群**：MySQL主从复制，读写分离
3. **缓存集群**：Redis集群，高可用部署
4. **监控告警**：系统监控，性能指标告警
5. **日志管理**：集中化日志收集和分析


## 🔧 开发规范

- **Go代码**：遵循Go官方代码规范
- **Vue代码**：遵循Vue官方风格指南
- **API设计**：RESTful API设计原则
- **数据库**：遵循数据库设计范式


